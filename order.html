<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ÙØ±Ù… Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´ Ø¯ÙˆØ±Ù‡</title>
  <link rel="icon" href="https://framerusercontent.com/images/WaE9y1q8u84RBhVkrUOim42h24I.png" />
  <link rel="stylesheet" href="index.css" />
  <style>
    :root { --lp-primary:#0d6efd; --lp-success:#00ff87; --lp-danger:#ff5e5e; }
    body { background: radial-gradient(1000px 600px at 70% 30%, rgba(0,255,135,0.08), transparent 60%),
                     radial-gradient(800px 500px at 20% 70%, rgba(96,239,255,0.08), transparent 60%),
                     #0b3a2b; }
    .checkout-wrap { max-width: 980px; margin: 40px auto; padding: 0 1rem; }
    .top-banner { background: #e74c3c; color:#fff; border-radius:14px; box-shadow:0 16px 40px rgba(0,0,0,.35); padding: 16px 20px; display:flex; justify-content:space-between; align-items:center; gap:12px; }
    .top-banner .left { display:flex; align-items:center; gap:10px; font-family:'EstedadBold'; }
    .badge { background: rgba(255,255,255,.15); border-radius:999px; padding:8px 12px; display:inline-flex; align-items:center; gap:8px; }
    .pill { background:#ffb199; color:#581c0c; font-family:'EstedadBold'; border-radius:999px; padding:8px 12px; }
    .tabs { background:#fff; border-radius:10px; overflow:hidden; margin-top:16px; }
    .tab-headers { display:grid; grid-template-columns: 1fr 1fr; border-bottom:2px solid #0d6efd; }
    .tab-headers .tab { padding:10px 12px; text-align:center; font-family:'EstedadBold'; background:#f7f9fc; }
    .tab-headers .tab.active { color:#0d6efd; }
    .form-card { background:#fff; border-radius:12px; padding:18px; box-shadow: 0 12px 30px rgba(0,0,0,.25); }
    .form-row { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .form-group { margin:10px 0; }
    .form-group label { display:block; margin-bottom:6px; color:#333; font-family:'EstedadBold'; }
    .form-group input { width:100%; border:1px solid #d9d9d9; border-radius:8px; padding:12px; font-size:1rem; }
    .form-actions { margin-top:18px; }
    .submit-btn { width:100%; background:#0d6efd; color:#fff; border:none; border-radius:10px; padding:14px; font-size:1.05rem; font-family:'EstedadBold'; cursor:pointer; }
    .submit-btn:disabled { opacity:.6; cursor:not-allowed; }
    .hint { color:#666; text-align:center; margin-top:8px; font-size:.9rem; }
    .status { margin-top:12px; padding:10px; border-radius:8px; display:none; }
    .status.error { display:block; background:#ffecec; color:#b00020; }
    .status.success { display:block; background:#e7fff3; color:#0a5230; }

    /* New Animated Toggle Styles */
    .toggle-wrapper {
      position: relative;
      display: flex;
      background: #f1f5f9;
      border-radius: 12px;
      padding: 4px;
      margin: 20px 0;
      cursor: pointer;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
      font-family: 'EstedadBold';
      user-select: none;
    }
    .toggle-option {
      flex: 1;
      text-align: center;
      padding: 12px;
      z-index: 2;
      color: #64748b;
      transition: color 0.3s ease;
      position: relative;
    }
    .toggle-option.active {
      color: #0d6efd;
    }
    .toggle-glider {
      position: absolute;
      top: 4px;
      bottom: 4px;
      right: 4px; /* Start at Right (Email) because RTL */
      width: calc(50% - 4px);
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: transform 0.35s cubic-bezier(0.34, 1.56, 0.64, 1); /* Bouncy effect */
      z-index: 1;
    }
    /* When Mobile (Left side in RTL) is selected */
    .toggle-wrapper[data-selected="mobile"] .toggle-glider {
      transform: translateX(-102%); /* Move to left */
    }

    /* Input Animations */
    .input-anim-container {
      position: relative;
      overflow: hidden;
      transition: max-height 0.4s ease;
    }
    .contact-input-group {
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      opacity: 0;
      transform: translateY(10px);
      position: absolute;
      width: 100%;
      top: 0;
      left: 0;
      pointer-events: none;
    }
    .contact-input-group.active {
      opacity: 1;
      transform: translateY(0);
      position: relative;
      pointer-events: auto;
    }
    /* Styles for discount row */
    .discount-row { display:flex; gap:8px; }
    .apply-btn { background:#0d6efd; color:#fff; border:none; border-radius:8px; padding:0 16px; font-family:'EstedadBold'; cursor:pointer; transition:background .2s; }
    .apply-btn:hover { background:#0b5ed7; }
    .voucher-result { margin-top:8px; font-size:0.9rem; }
    .voucher-result.success { color:#0a5230; background:#e7fff3; padding:8px; border-radius:6px; }
    .voucher-result.error { color:#b00020; background:#ffecec; padding:8px; border-radius:6px; }
    .price-details { display:flex; flex-direction:column; gap:4px; margin-top:4px; }
    .price-row { display:flex; justify-content:space-between; }
    .final-price { font-weight:bold; color:#0d6efd; border-top:1px dashed #ccc; padding-top:4px; margin-top:4px; }
  </style>
</head>
<body style="font-family: 'EstedadRegular';">
  <div class="checkout-wrap">
    <div class="top-banner" aria-label="Ø§Ø·Ù„Ø§Ø¹ÛŒÙ‡ Ø¸Ø±ÙÛŒØª">
      <div class="left">
        <span>âš ï¸ Ø¸Ø±ÙÛŒØª Ù…Ø­Ø¯ÙˆØ¯: ÙÙ‚Ø· <span id="capacity-total">â€”</span> Ø¬Ø§ÛŒÚ¯Ø§Ù‡ Ø§ÛŒÙ† Ù…Ø§Ù‡!</span>
        <span class="badge">ğŸ”¥ <span id="spots-left">â€”</span> Ø¬Ø§ÛŒÚ¯Ø§Ù‡ Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡</span>
        <span class="badge">âš¡ï¸ <span id="purchased-count">â€”</span> Ø¬Ø§ÛŒÚ¯Ø§Ù‡ Ø±Ø²Ø±Ùˆ Ø´Ø¯Ù‡</span>
      </div>
      <!-- <div class="pill" id="base-url-pill" title="Base URL"></div> -->
    </div>

    <div class="tabs" role="tablist">
      <div class="tab-headers">
        <div class="tab active">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ø®ØµÛŒ Ø´Ù…Ø§</div>
        <div class="tab">Ù¾Ø±Ø¯Ø§Ø®Øª</div>
      </div>
      <div class="form-card" role="tabpanel" aria-labelledby="Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ø®ØµÛŒ Ø´Ù…Ø§">
        <form id="order-form" novalidate>
          <input type="hidden" id="course_variant_id" />
          <div class="form-row">
            <div class="form-group">
              <label for="first_name">Ù†Ø§Ù…</label>
              <input id="first_name" name="first_name" placeholder="Ù…Ø«Ø§Ù„: Ø¹Ù„ÛŒ" required />
            </div>
            <div class="form-group">
              <label for="last_name">Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ</label>
              <input id="last_name" name="last_name" placeholder="Ù…Ø«Ø§Ù„: Ø§Ø­Ù…Ø¯ÛŒ" required />
            </div>
          </div>
          
          <div class="form-group">
            <label>Ø±ÙˆØ´ ØªÙ…Ø§Ø³</label>
            <div class="toggle-wrapper" id="contactToggle" data-selected="email">
              <div class="toggle-glider"></div>
              <div class="toggle-option active" data-value="email">Ø§ÛŒÙ…ÛŒÙ„</div>
              <div class="toggle-option" data-value="mobile">Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„</div>
            </div>
          </div>

          <div class="input-anim-container">
            <div class="contact-input-group active" id="group-email">
              <div class="form-group">
                <label for="email">Ø§ÛŒÙ…ÛŒÙ„</label>
                <input id="email" name="email" type="email" placeholder="ali@example.com" />
              </div>
            </div>
            <div class="contact-input-group" id="group-mobile">
              <div class="form-group">
                <label for="mobile_number">Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„</label>
                <input id="mobile_number" name="mobile_number" inputmode="tel" placeholder="09123456789" />
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="discount_code">Ú©Ø¯ ØªØ®ÙÛŒÙ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
            <div class="discount-row">
              <input id="discount_code" name="discount_code" placeholder="Ù…Ø«Ø§Ù„: AOC50" />
              <button type="button" class="apply-btn" id="applyVoucherBtn">Ø§Ø¹Ù…Ø§Ù„</button>
            </div>
            <div id="voucherResult" class="voucher-result"></div>
          </div>
          <div class="form-actions">
            <button type="submit" class="submit-btn" id="submitBtn">Ø§Ø¯Ø§Ù…Ù‡ Ùˆ Ø§Ø±Ø³Ø§Ù„ Ø§Ø·Ù„Ø§Ø¹Ø§Øª</button>
            <p class="hint">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ù…Ø§ Ù†Ø²Ø¯ Ù…Ø§ Ù…Ø­ÙÙˆØ¸ Ø§Ø³Øª.</p>
            <div class="status" id="status"></div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    const statusEl = document.getElementById('status');
    const submitBtn = document.getElementById('submitBtn');

    // Base URL configuration
    const urlParams = new URLSearchParams(window.location.search);
    const paramBase = urlParams.get('baseUrl');
    if (paramBase) localStorage.setItem('lp_base_url', paramBase);
    const BASE_URL = localStorage.getItem('lp_base_url') || 'https://api.persianball.ir';
    // document.getElementById('base-url-pill').textContent = BASE_URL ? BASE_URL : 'Base URL: ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡';

    // Get course variant id from query or default
    const courseId = parseInt(urlParams.get('course_variant_id') || '79', 10);
    document.getElementById('course_variant_id').value = courseId;

    // Contact Method Toggle Logic
    const toggleWrapper = document.getElementById('contactToggle');
    const options = document.querySelectorAll('.toggle-option');
    const groupEmail = document.getElementById('group-email');
    const groupMobile = document.getElementById('group-mobile');
    let currentMethod = 'email';

    options.forEach(opt => {
      opt.addEventListener('click', () => {
        const val = opt.dataset.value;
        if (val === currentMethod) return;
        
        // Update Toggle UI
        currentMethod = val;
        toggleWrapper.setAttribute('data-selected', val);
        options.forEach(o => o.classList.remove('active'));
        opt.classList.add('active');

        // Update Inputs UI
        if (val === 'email') {
          groupEmail.classList.add('active');
          groupMobile.classList.remove('active');
          document.getElementById('mobile_number').value = ''; // Clear other input
        } else {
          groupMobile.classList.add('active');
          groupEmail.classList.remove('active');
          document.getElementById('email').value = ''; // Clear other input
        }
      });
    });

    function showStatus(text, type) {
      statusEl.textContent = text;
      statusEl.className = 'status ' + type;
    }

    async function fetchStockInfo() {
      try {
        const res = await fetch(`${BASE_URL}/v1/product/course-variant/${courseId}/stock-info/`, {
          headers: { 'Content-Type': 'application/json' }
        });
        if (!res.ok) throw new Error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¸Ø±ÙÛŒØª Ø¯ÙˆØ±Ù‡');
        const data = await res.json();
        const { total_capacity, purchased_count, available_spots } = data || {};
        const capEl = document.getElementById('capacity-total');
        const purchasedEl = document.getElementById('purchased-count');
        const leftEl = document.getElementById('spots-left');
        if (typeof total_capacity === 'number') capEl.textContent = total_capacity;
        if (typeof purchased_count === 'number') purchasedEl.textContent = purchased_count;
        if (typeof available_spots === 'number') leftEl.textContent = available_spots;
      } catch (err) {
        console.warn('Stock info error:', err);
        // Ù†Ù…Ø§ÛŒØ´ Ù…Ù‚Ø§Ø¯ÛŒØ± Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø§Ú¯Ø± Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯
        document.getElementById('capacity-total').textContent = document.getElementById('capacity-total').textContent || 'â€”';
        document.getElementById('purchased-count').textContent = document.getElementById('purchased-count').textContent || 'â€”';
        document.getElementById('spots-left').textContent = document.getElementById('spots-left').textContent || 'â€”';
      }
    }
    fetchStockInfo();

    // ----- Voucher (Discount) Verification -----
    const applyBtn = document.getElementById('applyVoucherBtn');
    const voucherResult = document.getElementById('voucherResult');
    let appliedVoucher = null;

    function formatCurrency(n) {
      if (typeof n !== 'number') return 'â€”';
      return n.toLocaleString('fa-IR');
    }

    async function applyVoucher() {
      const code = document.getElementById('discount_code').value.trim();
      if (!code) {
        voucherResult.style.color = '#b00020';
        voucherResult.textContent = 'Ú©Ø¯ ØªØ®ÙÛŒÙ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯';
        return;
      }
      if (!BASE_URL) { showStatus('Base URL ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.', 'error'); return; }
      applyBtn.disabled = true;
      voucherResult.style.color = '#333';
      voucherResult.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ø¯ ØªØ®ÙÛŒÙ...';
      try {
        const res = await fetch(`${BASE_URL}/v1/payment/voucher/verify/`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ code, course_variant_id: courseId })
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          const msg = data?.detail || 'Ú©Ø¯ ØªØ®ÙÛŒÙ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª';
          throw new Error(msg);
        }
        appliedVoucher = { code, ...data };
        voucherResult.style.color = '#0a5230';
        voucherResult.textContent = `ØªØ®ÙÛŒÙ ${data.discount_percent}% â€” Ù‚ÛŒÙ…Øª Ø§ØµÙ„ÛŒ ${formatCurrency(data.discount_amount)} â€” Ù‚ÛŒÙ…Øª Ù†Ù‡Ø§ÛŒÛŒ ${formatCurrency(data.final_price)} ØªÙˆÙ…Ø§Ù†`;
        showStatus('Ú©Ø¯ ØªØ®ÙÛŒÙ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¹Ù…Ø§Ù„ Ø´Ø¯.', 'success');
      } catch (err) {
        appliedVoucher = null;
        voucherResult.style.color = '#b00020';
        voucherResult.textContent = err.message;
      } finally {
        applyBtn.disabled = false;
      }
    }
    applyBtn.addEventListener('click', applyVoucher);

    function validateForm(values, selectedMethod) {
      const errors = [];
      if (!values.first_name?.trim()) errors.push('Ù†Ø§Ù… Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
      if (!values.last_name?.trim()) errors.push('Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
      if (selectedMethod === 'email') {
        if (!values.email?.trim()) errors.push('Ø§ÛŒÙ…ÛŒÙ„ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
        else if (!/^\S+@\S+\.\S+$/.test(values.email)) errors.push('Ø§ÛŒÙ…ÛŒÙ„ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª');
      } else if (selectedMethod === 'mobile') {
        const mobile = values.mobile_number?.replace(/\D/g,'') || '';
        if (!mobile) errors.push('Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
        else if (!/^\d{10,}$/.test(mobile)) errors.push('Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª');
      }
      return errors;
    }

    // const contactRadios = document.querySelectorAll('input[name="contact_method"]');
    // function updateContactVisibility() {
    //   const selected = document.querySelector('input[name="contact_method"]:checked').value;
    //   document.querySelectorAll('.contact-field').forEach(el => {
    //     const show = el.getAttribute('data-method') === selected;
    //     el.style.display = show ? '' : 'none';
    //     if (!show) {
    //       const input = el.querySelector('input');
    //       if (input) input.value = '';
    //     }
    //   });
    // }
    // contactRadios.forEach(r => r.addEventListener('change', updateContactVisibility));
    // updateContactVisibility();

    document.getElementById('order-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const selectedMethod = document.querySelector('.toggle-option.active').getAttribute("data-value");
      const values = {
        course_variant_id: courseId,
        first_name: document.getElementById('first_name').value.trim(),
        last_name: document.getElementById('last_name').value.trim(),
      };
      if (selectedMethod === 'email') {
        values.email = document.getElementById('email').value.trim();
      } else {
        values.mobile_number = document.getElementById('mobile_number').value.trim();
      }
      const discountCode = document.getElementById('discount_code').value.trim();
      if (discountCode) values.voucher_code = discountCode; // Ù…Ø·Ø§Ø¨Ù‚ Ù…Ø³ØªÙ†Ø¯Ø§Øª API

      const errs = validateForm(values, selectedMethod);
      if (errs.length) { showStatus(errs.join(' â€” '), 'error'); return; }
      if (!BASE_URL) { showStatus('Base URL ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª. ?baseUrl=... Ø±Ø§ Ø¨Ù‡ Ø¢Ø¯Ø±Ø³ ØµÙØ­Ù‡ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ø¯Ø± localStorage Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†ÛŒØ¯.', 'error'); return; }

      submitBtn.disabled = true; showStatus('Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ Ø§Ø·Ù„Ø§Ø¹Ø§Øª...', 'success');
      try {
        const res = await fetch(`${BASE_URL}/v1/order/landing-page-order/`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(values)
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          const msg = data?.detail || data?.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø§Ø·Ù„Ø§Ø¹Ø§Øª';
          throw new Error(msg);
        }
        // Ù…ÙˆÙÙ‚: Ø±ÛŒØ¯Ø§ÛŒØ±Ú©Øª Ø¨Ù‡ Ø¯Ø±Ú¯Ø§Ù‡ ÛŒØ§ Ø§Ø¹Ù„Ø§Ù… Ù¾Ø§ÛŒØ§Ù† Ø¨Ø±Ø§ÛŒ Ø¯ÙˆØ±Ù‡ Ø±Ø§ÛŒÚ¯Ø§Ù†
        if (data.redirect_url) {
          showStatus('Ø«Ø¨Øª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯. Ø§Ù†ØªÙ‚Ø§Ù„ Ø¨Ù‡ Ø¯Ø±Ú¯Ø§Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª...', 'success');
          window.location.href = data.redirect_url;
        } else if (data.status === 'done') {
          showStatus('Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø¯ÙˆØ±Ù‡ Ø±Ø§ÛŒÚ¯Ø§Ù† Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯.', 'success');
        } else {
          showStatus('Ø«Ø¨Øª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯.', 'success');
        }
      } catch (err) {
        showStatus(err.message, 'error');
      } finally { submitBtn.disabled = false; }
    });
  </script>
</body>
</html>
